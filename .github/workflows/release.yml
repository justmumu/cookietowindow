name: Create Release

on:
  push:
    tags:
      - 'v*'  # Triggers on version tags like v1.0.0, v2.0.0, etc.

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      
      - name: Create distribution package
        run: |
          mkdir -p dist
          zip -r dist/CookieToWindow-v${{ steps.get_version.outputs.VERSION }}.zip \
            manifest.json \
            background.js \
            content.js \
            popup.html \
            popup.css \
            popup.js \
            icons/icon16.png \
            icons/icon48.png \
            icons/icon128.png \
            README.md \
            LICENSE
      
      - name: Generate changelog
        id: changelog
        run: |
          echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
          git log $(git describe --tags --abbrev=0 HEAD^)..HEAD --pretty=format:"- %s" >> $GITHUB_OUTPUT || echo "- Initial release" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: CookieToWindow v${{ steps.get_version.outputs.VERSION }}
          body: |
            ## ‚ú® Highlights
            
            - üç™ **Access HttpOnly cookies** - Read all cookies including HttpOnly via `window.__ALL_COOKIES__`
            - ‚ö° **Real-time updates** - Automatically updates when cookies change
            - ü§ñ **Automation ready** - Perfect for Puppeteer, Selenium, Playwright
            - üîÑ **Zero interaction** - Works in headless Chrome without manual steps
            
            ---
            
            ## üì¶ Installation
            
            1. Download `CookieToWindow-v${{ steps.get_version.outputs.VERSION }}.zip` below
            2. Extract the ZIP file
            3. Open Chrome ‚Üí `chrome://extensions/`
            4. Enable **Developer mode**
            5. Click **Load unpacked** and select the extracted folder
            
            üìñ [Full Documentation](https://github.com/justmumu/cookietowindow#readme)
            
            ---
            
            ## üöÄ Quick Start
            
            ```javascript
            const browser = await puppeteer.launch({
              args: [
                '--disable-extensions-except=/path/to/CookieToWindow',
                '--load-extension=/path/to/CookieToWindow'
              ]
            });
            const page = await browser.newPage();
            await page.goto('https://example.com');
            
            // Access all cookies including HttpOnly
            const cookies = await page.evaluate(() => window.__ALL_COOKIES__);
            console.log(cookies);
            ```
            
            ---
            
            ## üìã What's Changed
            
            ${{ steps.changelog.outputs.CHANGELOG }}
            
            ---
            
            ## ‚ö†Ô∏è Security Warning
            
            **This extension intentionally bypasses HttpOnly cookie protection.** 
            
            - ‚ùå Never use on production websites
            - ‚ùå Never use on sites with sensitive data
            - ‚úÖ Only use in isolated testing environments
            - ‚úÖ Only use for automation and development
            
            The developers are not responsible for any security issues arising from misuse of this extension.
          files: dist/CookieToWindow-v${{ steps.get_version.outputs.VERSION }}.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

